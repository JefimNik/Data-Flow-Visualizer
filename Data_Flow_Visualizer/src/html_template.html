<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Data Flow Visualizer</title>
<script src="https://unpkg.com/vis-network/standalone/umd/vis-network.min.js"></script>
<style>
  body {margin:0;display:flex;height:100vh;background:#111;color:#eee;font-family:"Segoe UI",sans-serif;}
  #mynetwork {flex:2;background:#1b1b1b;}
  #details {flex:1;background:#141414;padding:12px;overflow-y:auto;border-left:2px solid #222;}
  #filter {padding:10px;border-bottom:1px solid #333;background:#1d1d1d;}
  table {border-collapse:collapse;width:100%;font-size:13px;margin-top:8px;}
  th,td {border:1px solid #333;padding:4px 6px;word-break:break-word;}
  th {background:#222;color:#ffdf6b;}
</style>
</head>
<body>
<div id="mynetwork"></div>
<div id="details">
<div id="filter">
  <b>Фильтр по типу данных:</b><br>
  <label><input type="checkbox" class="dtype" value="materials" checked> materials</label><br>
  <label><input type="checkbox" class="dtype" value="progress" checked> progress</label><br>
  <label><input type="checkbox" class="dtype" value="hours" checked> hours</label><br>
  <label><input type="checkbox" class="dtype" value="cost" checked> cost</label><br>
  <label><input type="checkbox" class="dtype" value="workers" checked> workers</label><br>
  <label><input type="checkbox" class="dtype" value="documents" checked> documents</label><br>

  <hr style="margin:8px 0;border:0;border-top:1px solid #333">
  <b>Фильтр по типу передачи:</b><br>
  <label><input type="checkbox" class="ttype" value="pq" checked> pq</label><br>
  <label><input type="checkbox" class="ttype" value="manual" checked> manual</label><br>
  <label><input type="checkbox" class="ttype" value="planned" checked> planned</label><br>
</div>
  <div id="info"><p>Нажмите на узел или стрелку</p></div>
</div>

<script id="NODE_DATA" type="application/json">__NODE_DATA__</script>
<script id="VIS_NODES" type="application/json">__VIS_NODES__</script>
<script id="VIS_EDGES" type="application/json">__VIS_EDGES__</script>

<script>
function asText(v) {
  if (v === null || v === undefined) return "";
  return String(v);
}

const nodeData = JSON.parse(document.getElementById("NODE_DATA").textContent || "{}");
const nodesRaw = JSON.parse(document.getElementById("VIS_NODES").textContent || "[]");
const edgesRaw = JSON.parse(document.getElementById("VIS_EDGES").textContent || "[]");

const nodes = new vis.DataSet(nodesRaw);
const edges = new vis.DataSet(edgesRaw);
const container = document.getElementById("mynetwork");

const network = new vis.Network(container, { nodes, edges }, {
  physics: { enabled: true, barnesHut: { gravitationalConstant: -3000 } },
  nodes: { shape: "box", font: { color: "#0e0e0e", size: 14 }, borderWidth: 1, margin: 10,
           color: { background: "#1b1b1b", border: "#333" } },
  edges: { smooth: { type: "cubicBezier" }, width: 1.4 }
});

const info = document.getElementById("info");

network.on("click", p => {
  if (p.nodes.length > 0) {
    const id = p.nodes[0];
    const n = nodeData[id];
    if (!n) { info.innerHTML = `<h3>${asText(id)}</h3>`; return; }

    let html = `<h3>${asText(id)}</h3>
                <p><b>Тип:</b> ${asText(n.type)}</p>
                <p><b>Слой:</b> ${asText(n.layer)}</p>
                <p>${asText(n.comment)}</p>`;

    if (n.columns && n.columns.length) {
      // ✅ Берем порядок колонок из первой строки, без сортировки
      const keys = Object.keys(n.columns[0]);

      html += "<table><thead><tr>";
      keys.forEach(k => html += `<th>${asText(k)}</th>`);
      html += "</tr></thead><tbody>";

      n.columns.forEach(row => {
        html += "<tr>";
        keys.forEach(k => html += `<td>${asText(row[k])}</td>`);
        html += "</tr>";
      });

      html += "</tbody></table>";
    } else {
      html += "<p><i>Нет данных о колонках</i></p>";
    }

    info.innerHTML = html;
  }
  else if (p.edges.length > 0) {
    const e = edges.get(p.edges[0]);
    let html = `<h3>${asText(e.from)} → ${asText(e.to)}</h3>
                <p><b>Тип передачи:</b> ${asText(e.transfer_type)}</p>
                <p><b>Тип данных:</b> ${asText(e.data_type)}</p>`;
    if (e.transfer && e.transfer.length) {
      html += `<table><tr><th>Поле</th><th>Описание</th></tr>`;
      e.transfer.forEach(t => html += `<tr><td>${asText(t[0])}</td><td>${asText(t[1])}</td></tr>`);
      html += `</table>`;
    }
    info.innerHTML = html;
  }
});

// ---- фильтры ----
function applyFilters() {
  const activeData = Array.from(document.querySelectorAll('.dtype:checked')).map(c => c.value);
  const activeTransfer = Array.from(document.querySelectorAll('.ttype:checked')).map(c => c.value);
  edgesRaw.forEach(e => {
    const visible = activeData.includes(e.data_type) && activeTransfer.includes(e.transfer_type);
    edges.update({ id: e.id, hidden: !visible });
  });
}
document.querySelectorAll('.dtype, .ttype').forEach(chk => chk.addEventListener('change', applyFilters));

function highlightNode(nodeName) {
  if (!nodes.getIds().includes(nodeName)) return;
  network.selectNodes([nodeName]);
  network.focus(nodeName, { scale: 1.1, animation: true });
}
window.highlightNode = highlightNode;
</script>

</body>
</html>
